<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Gestión de Ficheros - ParisAndBea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fuente Raleway y Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Tu CSS base (opcional) -->
  <link rel="stylesheet" href="css/style.css">

  <!-- SweetAlert2 para alerts bonitos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ======= RESET / BASE ======= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Raleway', sans-serif;
      background: #add1c5;
      color: #333;
      line-height: 1.6;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* ======= HEADER ======= */
    header {
      background: #fff;
      padding: 1.5rem 1rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    header img {
      max-width: 180px;
      height: auto;
    }

    /* ======= TABS ======= */
    .tabs {
      display: flex;
      justify-content: center;
      background: #fff;
      border-bottom: 2px solid #f0f0f0;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      /* Permite que las pestañas hagan wrap en pantallas pequeñas */
    }

    .tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      color: #d2d2db;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.3s, color 0.3s, border-bottom 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      background: rgba(85, 85, 85, 0.1);
    }

    .tab.active {
      color: #333;
      font-weight: 600;
      border-bottom: 3px solid #add1c5;
    }

    /* ======= CONTENEDOR PRINCIPAL ======= */
    .container {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
      min-height: 70vh;
    }

    /* ======= TABLA DE ARCHIVOS ======= */
    .table-responsive {
      overflow-x: auto;
      margin-top: 1rem;
    }

    table.file-list {
      width: 100%;
      border-collapse: collapse;
    }

    .file-list th,
    .file-list td {
      padding: 1rem;
      text-align: center;
      border: 1px solid #eee;
    }

    .file-list th {
      background: #f7f7f7;
      font-weight: 600;
    }

    .file-name {
      cursor: pointer;
      color: #007BFF;
      transition: color 0.3s;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-name:hover {
      color: #0056b3;
    }

    .actions button {
      border: none;
      background: none;
      color: #333;
      transition: transform 0.2s;
      cursor: pointer;
    }

    .actions button:hover {
      transform: scale(1.1);
    }

    /* ======= BOTONERA ======= */
    .botonera {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .botonera input[type="file"] {
      flex: 1;
    }

    .botonera button {
      padding: 0.75rem 1.5rem;
      background: #add1c5;
      font-size: 1rem;
      color: #fff;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }

    .botonera button:hover {
      background: #6a9c8c;
      transform: scale(1.05);
    }

    #deleteSelectedBtn {
      background: #fb7777;
    }

    #deleteSelectedBtn:hover {
      background: #c05c5c;
    }

    #fileInput {
      padding: 1rem 2rem;
      background: #add1c5;
      font-size: 1rem;
      color: #fff;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      max-width: 100%;
      font-family: 'Raleway', sans-serif;
    }

    /* ======= FORM CAMBIO PASSWORD ======= */
    .password-form {
      max-width: 400px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .password-form h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 1.4rem;
      color: #333;
    }

    .password-form div {
      margin-bottom: 1rem;
    }

    .password-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .password-form input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }

    .password-form button {
      width: 100%;
      padding: 0.75rem;
      background: #add1c5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }

    .password-form button:hover {
      background: #6a9c8c;
      transform: scale(1.02);
    }

    /* ======= MODAL PARA PREVISUALIZAR IMÁGENES ======= */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: #fff;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-content img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: transform 0.3s;
      cursor: zoom-in;
    }

    .modal-content img.zoom {
      transform: scale(2);
      cursor: zoom-out;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #333;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
    }

    /* ======= FOOTER ======= */
    footer {
      background: #f1f1f1;
      color: #5b5b5b;
      text-align: center;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-top: 2rem;
      border-top: 1px solid #e0e0e0;
    }

    footer img {
      max-width: 150px;
      vertical-align: middle;
    }

    .logout-button {
      background: #add1c5;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      color: #fff;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: 'Raleway', sans-serif;
    }

    .logout-button:hover {
      background: #6a9c8c;
      transform: scale(1.05);
    }

    /* ======= SPINNER ======= */
    #loadingSpinner {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    #loadingSpinner .spinner-content {
      background: #fff;
      padding: 1rem 2rem;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* ======= MEDIA QUERIES ======= */
    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }

      .tab {
        justify-content: center;
      }

      .file-list th,
      .file-list td {
        padding: 0.75rem;
      }

      .file-list th:nth-child(1),
      .file-list td:nth-child(1) {
        width: 50px;
      }

      .file-list th:nth-child(3),
      .file-list td:nth-child(3) {
        width: 70px;
      }

      .file-list th:nth-child(2),
      .file-list td:nth-child(2) {
        width: auto;
      }

      .file-name {
        white-space: normal;
        word-wrap: break-word;
        overflow: visible;
        text-overflow: clip;
      }
    }

    @media (max-width: 450px) {
      .tab {
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
      }

      .password-form {
        margin: 1.5rem auto;
        padding: 1.5rem;
      }
    }

    /* ======= ESTILOS SWEETALERT2 ======= */
    button:where(.swal2-styled):where(.swal2-confirm) {
      background-color: #add1c5 !important;
      font-family: 'Raleway', sans-serif;
      border-radius: 10px !important;
    }

    div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-cancel) {
      background-color: #fb7777 !important;
      font-family: 'Raleway', sans-serif;
      border-radius: 10px;
    }

    div:where(.swal2-container).swal2-center>.swal2-popup {
      border-radius: 15px;
    }

    /* BOTÓN HAMBURGUESA – oculto en escritorio */
    .tabs-toggle {
      display: none;
      position: fixed;
      top: 14px;
      left: 14px;
      background: #add1c5;
      border: none;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .25);
      z-index: 1200;
    }

    .tabs-toggle .material-icons {
      font-size: 28px;
      margin-top: 4px
    }

    /* Al estado “open” giramos el icono */
    .tabs-toggle.open {
      background: #6a9c8c;
    }

    .tabs-toggle.open .material-icons {
      transform: rotate(90deg);
    }

    /* Modo móvil */
    @media (max-width:600px) {
      .tabs {
        /* inicialmente ocultas */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        flex-direction: column;
        transform: translateY(-100%);
        transition: transform .35s ease;
        z-index: 1100;
      }

      .tabs.show {
        transform: translateY(0);
      }

      .tabs-toggle {
        display: block;
      }

      body.menu-open {
        overflow: hidden;
      }

      /* evita scroll fondo */
    }
  </style>
</head>

<body>
  <!-- ======= HEADER ======= -->
  <header>
    <img src="images/recursos/parisandbealogo.png" alt="ParisAndBea Logo">
  </header>
  <button id="tabsToggle" class="tabs-toggle">
    <span class="material-icons">menu</span>
  </button>
  <!-- ======= TABS ======= -->
  <div class="tabs">
    <div class="tab active" data-folder="documentos">
      <i class="material-icons">description</i> Documentos
    </div>
    <div class="tab" data-folder="documentos/consentimientos">
      <i class="material-icons">wysiwyg</i> Consent.
    </div>
    <div class="tab" data-folder="documentos/consentimientos_firmados">
      <i class="material-icons">edit_square</i> Consent. Firmados
    </div>
    <div class="tab" data-folder="attachments_mail">
      <i class="material-icons">mail</i> Adjuntos Mail
    </div>
    <div class="tab" data-folder="attachments_whatsapp">
      <i class="material-icons">chat</i> Adjuntos WhatsApp
    </div>
    <div class="tab" data-folder="attachments_consulta">
      <i class="material-icons">folder_shared</i> Adjuntos&nbsp;consulta
    </div>
    <div class="tab" data-folder="images">
      <i class="material-icons">public</i> Img Web
    </div>
    <div class="tab" data-folder="images/recursos">
      <i class="material-icons">wallpaper</i> Recursos
    </div>
    <div class="tab" data-folder="images/servicios">
      <i class="material-icons">sign_language</i> Img Servicios
    </div>
    <div class="tab" data-folder="images/profesionales">
      <i class="material-icons">badge</i> Img Profesionales
    </div>
    <div class="tab" data-folder="images/productos">
      <i class="material-icons">inventory_2</i> Img Productos
    </div>
    <div class="tab" data-folder="password">
      <i class="material-icons">lock</i> Password
    </div>
  </div>

  <!-- ======= CONTENEDOR PRINCIPAL ======= -->
  <div class="container">
    <!-- Contenido dinámico: tabla de archivos / formulario password -->
  </div>

  <!-- ======= MODAL PARA IMÁGENES ======= -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <img id="modalImage" src="" alt="Imagen">
    </div>
  </div>

  <!-- ======= SPINNER OVERLAY ======= -->
  <div id="loadingSpinner">
    <div class="spinner-content">
      Subiendo archivos...
    </div>
  </div>

  <!-- ======= FOOTER ======= -->
  <footer>
    <button class="logout-button" id="homeBtn">
      <i class="material-icons">home</i> Inicio
    </button><br>
    <img src="images/recursos/parisandbealogo.png" alt="Logo">
    <p>© 2025 Paris & Bea</p>
  </footer>

  <script>
    /* =========================================================
     *  PAB-FILES — Script completo (v. Profesionales + Servicios)
     * ========================================================= */

    /* 1) Carpeta inicial */
    let currentFolder = 'documentos';

    /* 1.1 Helpers para las pestañas “solo-imágenes” */
    const isServicios = () => currentFolder === 'images/servicios';
    const isProfesionales = () => currentFolder === 'images/profesionales';
    const isProductos = () => currentFolder === 'images/productos';
    const isOnlyImagesTab = () =>
      isServicios() || isProfesionales() || isProductos();

    /* 2) Pintar tabla / botones */
    function showFileList() {
      const container = document.querySelector('.container');
      container.innerHTML = `
    <div class="table-responsive">
      <table class="file-list" id="fileList">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>Archivo</th>
            ${currentFolder === 'attachments_consulta' ? '<th>ID Paciente</th><th>Paciente</th>' : ''}
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="botonera">
      <input type="file" id="fileInput" multiple />
      <button id="uploadBtn"><i class="material-icons">file_upload</i></button>
      <button id="deleteSelectedBtn"><i class="material-icons">delete</i></button>
    </div>
  `;

      /* limitar tipos aceptados sólo en las pestañas especiales */
      const fileInput = document.getElementById('fileInput');
      if (isOnlyImagesTab()) {
        fileInput.setAttribute('accept', 'image/*');
      } else {
        fileInput.removeAttribute('accept');
      }

      /* Select-all */
      document.getElementById('selectAll').onchange = function () {
        document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = this.checked);
      };

      /* Botones */
      document.getElementById('uploadBtn').onclick = uploadFilesHandler;
      document.getElementById('deleteSelectedBtn').onclick = deleteSelectedFilesHandler;

      loadFiles();
    }

    /* 3) Password (sin cambios) */
    function showPasswordForm() {
      /* … código idéntico … */
      /* omitido por brevedad: igual que tu versión previa */
    }

    /* 4) Cargar archivos */
    async function loadFiles() {
      try {
        const res = await fetch(`/api/files/${currentFolder}`);
        const data = await res.json();
        if (res.ok) renderFileList(data.files);
        else throw new Error(data.error || 'Error al cargar archivos');
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: e.message });
      }
    }

    /* 5) Renderizar tabla */
    function renderFileList(files) {
      const tbody = document.querySelector('#fileList tbody');
      tbody.innerHTML = '';

      files.forEach(f => {
        const obj = typeof f === 'object';
        const fileName = obj ? f.filename : f;
        const paciente = obj ? f.paciente : '';
        const idPaciente = obj ? f.id_paciente : '';
        const fileValue = obj ? f.filepath : fileName;

        tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td><input type="checkbox" class="file-checkbox" value="${fileValue}"></td>
        <td><span class="file-name" onclick="viewFile('${fileName}')">${fileName}</span></td>
        ${currentFolder === 'attachments_consulta' ? `<td>${idPaciente}</td><td>${paciente}</td>` : ''}
        <td class="actions">
          <button class="renameBtn" data-file="${fileName}">
            <i class="material-icons">edit</i>
          </button>
          <button class="delBtn" data-file="${fileValue}" data-paciente="${paciente.replace(/"/g, '&quot;')}">
            <i class="material-icons">delete</i>
          </button>
        </td>
      </tr>
    `);
      });

      tbody.querySelectorAll('.renameBtn').forEach(btn =>
        btn.onclick = () => renameFilePrompt(btn.dataset.file));
      tbody.querySelectorAll('.delBtn').forEach(btn =>
        btn.onclick = () => deleteFile(btn.dataset.file, btn.dataset.paciente));
    }

    /* 6) Subir archivos */
    async function uploadFilesHandler() {
      const input = document.getElementById('fileInput');
      if (!input.files.length) {
        return Swal.fire({ icon: 'warning', title: 'Atención', text: 'Selecciona al menos un archivo' });
      }

      /* validar sólo-imágenes en pestañas especiales */
      if (isOnlyImagesTab()) {
        const noImg = Array.from(input.files).filter(f => !f.type.startsWith('image/'));
        if (noImg.length) {
          return Swal.fire({
            icon: 'error',
            title: 'Solo imágenes',
            html: `Estos archivos no son imagen:<br><b>${noImg.map(f => f.name).join('<br>')}</b>`
          });
        }
      }

      /* spinner */
      document.getElementById('loadingSpinner').style.display = 'flex';

      try {
        const fd = new FormData();
        Array.from(input.files).forEach(f => fd.append('files', f));

        const res = await fetch(`/api/files/${currentFolder}/upload`, { method: 'POST', body: fd });
        const data = await res.json();

        if (res.ok) {
          Swal.fire({ icon: 'success', title: 'Éxito', text: data.message });
          input.value = '';
          loadFiles();
        } else {
          throw new Error(data.error || 'Error al subir archivos');
        }
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: e.message });
      } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    }

    /* 7) Eliminar múltiples */
    async function deleteSelectedFilesHandler() {
      const sel = [...document.querySelectorAll('.file-checkbox:checked')].map(cb => cb.value);
      if (!sel.length) {
        return Swal.fire({ icon: 'warning', title: 'Atención', text: 'Selecciona al menos un archivo para eliminar' });
      }

      const ok = await Swal.fire({
        title: '¿Eliminar los archivos seleccionados?',
        icon: 'warning', showCancelButton: true,
        confirmButtonText: 'Sí, eliminar', cancelButtonText: 'Cancelar'
      });
      if (!ok.isConfirmed) return;

      try {
        const res = await fetch(`/api/files/${currentFolder}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files: sel })
        });
        const data = await res.json();
        if (res.ok) {
          Swal.fire({ icon: 'success', title: 'Eliminado', text: data.message });
          loadFiles();
        } else throw new Error(data.error || 'Error al eliminar archivos');
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: e.message });
      }
    }

    /* 8) Eliminar uno */
    async function deleteFile(fileName, paciente = '') {
      const titulo = currentFolder === 'attachments_consulta'
        ? `¿Eliminar el archivo “${fileName}” del paciente “${paciente}”?`
        : `¿Eliminar el archivo “${fileName}”?`;

      const ok = await Swal.fire({
        title: titulo, icon: 'warning',
        showCancelButton: true, confirmButtonText: 'Sí, eliminar', cancelButtonText: 'Cancelar'
      });
      if (!ok.isConfirmed) return;

      try {
        const res = await fetch(`/api/files/${currentFolder}/${encodeURIComponent(fileName)}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
          Swal.fire({ icon: 'success', title: 'Eliminado', text: data.message });
          loadFiles();
        } else throw new Error(data.error || 'No se eliminó');
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: e.message });
      }
    }

    /* 9) Renombrar */
    async function renameFilePrompt(oldName) {
      const { value: newName } = await Swal.fire({
        title: 'Renombrar archivo',
        input: 'text', inputValue: oldName, showCancelButton: true,
        inputValidator: v => !v && '¡Necesitas escribir un nombre!'
      });
      if (!newName || newName === oldName) return;

      try {
        const res = await fetch(`/api/files/${currentFolder}/rename`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ oldName, newName })
        });
        const data = await res.json();
        if (res.ok) {
          Swal.fire({ icon: 'success', title: 'Renombrado', text: data.message });
          loadFiles();
        } else throw new Error(data.error || 'Error al renombrar');
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'Error', text: e.message });
      }
    }

    /* 10) Previsualizar */
    function viewFile(file) {
      const url = `/${currentFolder}/${file}`;
      const ext = file.split('.').pop().toLowerCase();

      if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) {
        const modal = document.getElementById('modal');
        const img = document.getElementById('modalImage');
        img.src = url; img.classList.remove('zoom');
        modal.classList.add('show');
      } else if (ext === 'pdf') {
        window.open(url, '_blank');
      } else {
        Swal.fire({ icon: 'info', title: 'Info', text: 'No se puede previsualizar este tipo de archivo.' });
      }
    }

    /* 10.1 Cerrar modal */
    document.getElementById('modalClose').onclick = () =>
      document.getElementById('modal').classList.remove('show');
    document.getElementById('modal').onclick = e => {
      if (e.target.id === 'modal') e.target.classList.remove('show');
    };
    document.getElementById('modalImage').onclick = function () {
      this.classList.toggle('zoom');
    };

    /* 11) Tabs */
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFolder = tab.dataset.folder;
        currentFolder === 'password' ? showPasswordForm() : showFileList();

        /* cerrar hamburguesa en móvil */
        if (window.innerWidth <= 600) {
          document.querySelector('.tabs').classList.remove('show');
          document.getElementById('tabsToggle').classList.remove('open');
          document.body.classList.remove('menu-open');
        }
      };
    });

    /* 12) Home */
    document.getElementById('homeBtn').onclick = () => location.href = '/inicio-consulta.html';

    /* 13) Hamburger */
    document.getElementById('tabsToggle').onclick = function () {
      document.querySelector('.tabs').classList.toggle('show');
      this.classList.toggle('open');
      document.body.classList.toggle('menu-open');
    };

    /* 14) Arranque */
    document.addEventListener('DOMContentLoaded', showFileList);
  </script>

</body>

</html>